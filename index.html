<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å¥åº·é£²é£Ÿé¸æ“‡å™¨</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .panel {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
    }
    .center-panel {
      flex: 3;
      padding: 30px 20px;
      text-align: center;
      overflow-y: auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 15px;
      margin-top: 25px;
      padding: 10px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .item {
      padding: 15px;
      border: 2px solid #ccc;
      border-radius: 12px;
      background-color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.05);
    }
    .item:hover {
      transform: scale(1.03);
      background-color: #f1f1f1;
    }
    .active {
      border-color: #ff6b6b;
      background-color: #fff3f3;
      transform: scale(1.05);
    }
    #title {
      font-size: 24px;
    }
    #selection {
      font-size: 20px;
      font-weight: bold;
      margin-top: 20px;
      color: #333;
    }
    #suggestion {
      font-size: 18px;
      margin-top: 15px;
      padding: 12px;
      background-color: #e8f5e9;
      border-left: 5px solid #4caf50;
      color: #2e7d32;
      max-width: 700px;
      margin: 20px auto 0;
      white-space: pre-wrap;
      border-radius: 6px;
      display: none;
    }
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
      margin-top: 100px;
    }
    .btn {
      font-size: 20px;
      padding: 15px 25px;
      background-color: #fff;
      border: 2px solid #ccc;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100px;
      text-align: center;
    }
    .btn:hover {
      background-color: #fce4ec;
      border-color: #ff4081;
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="btn-group">
      <div class="btn" onclick="sendCommand('UP')">ğŸ”¼ ä¸Š</div>
      <div class="btn" onclick="sendCommand('LEFT')">â—€ï¸ å·¦</div>
      <div class="btn" onclick="sendCommand('RIGHT')">â–¶ï¸ å³</div>
      <div class="btn" onclick="sendCommand('DOWN')">ğŸ”½ ä¸‹</div>
    </div>
  </div>
  <div class="center-panel">
    <h1 id="title">é¸æ“‡ä½ æƒ³è¦çš„æ–™ç†</h1>
    <div id="menu" class="grid"></div>
    <h2 id="selection"></h2>
    <div id="suggestion"></div>
  </div>
  <div class="panel">
    <div class="btn-group">
      <div class="btn" onclick="sendCommand('CONFIRM')">âœ”ï¸ ç¢ºèª</div>
      <div class="btn" onclick="sendCommand('REJECT')">âœ–ï¸ å–æ¶ˆ</div>
    </div>
  </div>
  <button id="toggleHistoryBtn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 16px; font-size: 16px; border: none; background-color: #6c757d; color: white; border-radius: 8px; cursor: pointer;">ğŸ“œ æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
  <div id="historyArea" style="position: fixed; bottom: 70px; right: 20px; width: 300px; max-height: 300px; overflow-y: auto; background-color: #fff; border: 1px solid #ccc; padding: 15px; font-size: 14px; border-radius: 10px; display: none; box-shadow: 0 0 8px rgba(0,0,0,0.2);">
    <h4>ğŸ“– æ­·å²é¸æ“‡ç´€éŒ„</h4>
    <ul id="historyList" style="text-align: left; padding-left: 18px;"></ul>
    <button onclick="clearHistory()" style="margin-top: 10px;">ğŸ§¹ æ¸…é™¤ç´€éŒ„</button>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const categories = {
      "å°å¼æ–™ç†": ["æ»·è‚‰é£¯", "èšµä»”ç…", "é¹½é…¥é›"],
      "æ—¥å¼æ–™ç†": ["å£½å¸", "æ‹‰éºµ", "å®šé£Ÿ"],
      "éŸ“å¼æ–™ç†": ["çŸ³é‹æ‹Œé£¯", "çƒ¤è‚‰", "æ³¡èœé‹"],
      "ç¾å¼æ–™ç†": ["æ¼¢å ¡", "ç‰›æ’", "ç‚¸é›"],
      "æ³°å¼æ–™ç†": ["æ‰“æ‹‹è±¬", "ç¶ å’–å“©", "æœˆäº®è¦é¤…"],
      "è¶Šå¼æ–™ç†": ["æ²³ç²‰", "æ˜¥æ²", "è¶Šå¼ä¸‰æ˜æ²»"],
      "ç¾©å¼æ–™ç†": ["ç¾©å¤§åˆ©éºµ", "æŠ«è–©", "ç‡‰é£¯"],
      "æ¸¯å¼æ–™ç†": ["ç‡’è‡˜", "æ¸¯é»", "è…¸ç²‰"],
      "ä¸­å¼æ–™ç†": ["æ°´ç…®é­š", "å®®ä¿é›ä¸", "ç‚’éºµ"],
      "å°å°¼æ–™ç†": ["ç‚’é£¯", "æ²™å—²", "ç‰›è‚‰æ¹¯"],
      "è²å¾‹è³“æ–™ç†": ["ç‡‰è±¬è‚‰", "çƒ¤é›", "é…¸æ¹¯"],
      "å°åº¦æ–™ç†": ["å’–å“©", "çƒ¤é¤…", "é¦™æ–™é£¯"],
      "å¢¨è¥¿å“¥æ–™ç†": ["æ²é¤…", "å¡”å¯", "ç‰ç±³ç‰‡"],
      "è”¬é£Ÿæ–™ç†": ["è”¬èœç›¤", "æ¤ç‰©è‚‰", "ç´ ä¾¿ç•¶"],
      "åœ°ä¸­æµ·æ–™ç†": ["çƒ¤ç¾Šè‚‰", "æ©„æ¬–æ²™æ‹‰", "æµ·é®®é£¯"],
      "æ³•å¼æ–™ç†": ["å¯éº—é¤…", "ç´…é…’ç‡‰ç‰›è‚‰", "éµè‚é†¬"],
      "è¥¿ç­ç‰™æ–™ç†": ["æµ·é®®ç‡‰é£¯", "Tapas", "ç‡’çƒ¤"],
      "å¥åº·é¤": ["ä½é†£ä¾¿ç•¶", "é«˜è›‹ç™½é›èƒ¸", "æ²™æ‹‰"],
      "ç”œé»é£²å“": ["å¥¶èŒ¶", "åˆ¨å†°", "è±†èŠ±"]
    };
  let menuLevel = 'main';
  let currentIndex = 0;
  let mainKeys = Object.keys(categories);
  let subKeys = [];
  let selectedCategory = "";
  function renderMenu(items) {
    const menu = document.getElementById("menu");
    menu.innerHTML = '';
    if (menuLevel === 'main') items = [...mainKeys, "ğŸ“œ æŸ¥çœ‹æ­·å²ç´€éŒ„"];
    items.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item' + (index === currentIndex ? ' active' : '');
      div.innerText = item;
      menu.appendChild(div);
    });
  }
    function updateFocus(direction) {
      let items = (menuLevel === 'main')
        ? [...mainKeys, "ğŸ“œ æŸ¥çœ‹æ­·å²ç´€éŒ„"]
        : subKeys;

      const menu = document.getElementById("menu");
      const firstItem = menu.querySelector(".item");
      const itemWidth = firstItem ? firstItem.offsetWidth : 150;
      const menuWidth = menu.offsetWidth;
      const cols = Math.floor(menuWidth / (itemWidth + 15)); // +gap
      const total = items.length;
      const maxIndex = total - 1;

      switch (direction) {
        case 'LEFT':
          if (currentIndex % cols > 0) currentIndex--;
          break;
        case 'RIGHT':
          if (currentIndex % cols < cols - 1 && currentIndex < maxIndex) currentIndex++;
          break;
        case 'UP':
          if (currentIndex - cols >= 0) currentIndex -= cols;
          break;
        case 'DOWN':
          if (currentIndex + cols <= maxIndex) {
            currentIndex += cols;
          } else if (currentIndex < maxIndex) {
            currentIndex = maxIndex;  // ç§»åˆ°æœ€å¾Œä¸€æ ¼
          }
          break;
      }

      renderMenu(items);
    }



  function confirmSelection() {
    if (menuLevel === 'main') {
      if (currentIndex === mainKeys.length) return toggleHistory();
      selectedCategory = mainKeys[currentIndex];
      subKeys = categories[selectedCategory];
      currentIndex = 0;
      menuLevel = 'sub';
      document.getElementById("title").innerText = `è«‹é¸æ“‡ ${selectedCategory} å­åˆ†é¡`;
      renderMenu(subKeys);
    } else if (menuLevel === 'sub') {
      const selectedSub = subKeys[currentIndex];
      document.getElementById("selection").innerText = `ä½ é¸æ“‡çš„æ˜¯ï¼š${selectedCategory} â†’ ${selectedSub}`;
      document.getElementById("suggestion").innerText = "è«‹ç¨å€™...";
      document.getElementById("suggestion").style.display = "block";
      ws.send(JSON.stringify({ category: selectedCategory, sub: selectedSub }));
      saveToHistory(selectedCategory, selectedSub);
    }
  }
  function rejectSelection() {
    if (menuLevel === 'sub') {
      menuLevel = 'main';
      currentIndex = 0;
      document.getElementById("title").innerText = `é¸æ“‡ä½ æƒ³è¦çš„æ–™ç†`;
      document.getElementById("selection").innerText = '';
      document.getElementById("suggestion").innerText = '';
      document.getElementById("suggestion").style.display = "none";
      renderMenu(mainKeys);
    } else {
      document.getElementById("selection").innerText = `è«‹é‡æ–°é¸æ“‡`;
    }
  }
  function sendCommand(cmd) {
    ws.send(cmd);
  }
  function saveToHistory(category, sub) {
    const history = JSON.parse(localStorage.getItem("foodHistory") || "[]");
    const time = new Date().toLocaleString();
    history.unshift({ category, sub, time });
    localStorage.setItem("foodHistory", JSON.stringify(history));
  }
  function renderHistory() {
    const list = document.getElementById("historyList");
    list.innerHTML = '';
    const history = JSON.parse(localStorage.getItem("foodHistory") || "[]");
    if (history.length === 0) {
      list.innerHTML = "<li>å°šç„¡ç´€éŒ„</li>";
      return;
    }
    for (let item of history) {
      const li = document.createElement("li");
      li.textContent = `${item.time}ï¼š${item.category} â†’ ${item.sub}`;
      list.appendChild(li);
    }
  }
  function clearHistory() {
    localStorage.removeItem("foodHistory");
    renderHistory();
  }
  function toggleHistory() {
    const area = document.getElementById("historyArea");
    const btn = document.getElementById("toggleHistoryBtn");
    if (area.style.display === "block") {
      area.style.display = "none";
      btn.innerText = "ğŸ“œ æŸ¥çœ‹æ­·å²ç´€éŒ„";
    } else {
      renderHistory();
      area.style.display = "block";
      btn.innerText = "ğŸ™ˆ éš±è—æ­·å²ç´€éŒ„";
    }
  }
  document.getElementById("toggleHistoryBtn").onclick = toggleHistory;
  let ws = new WebSocket("ws://localhost:8000/ws");
  ws.onmessage = (event) => {
    const command = event.data;
    if (["UP", "DOWN", "LEFT", "RIGHT"].includes(command)) updateFocus(command);
    else if (command === 'CONFIRM') confirmSelection();
    else if (command === 'REJECT') rejectSelection();
    else {
      document.getElementById("suggestion").innerText = command;
      document.getElementById("suggestion").style.display = "block";
    }
  };
  renderMenu(mainKeys);
});
</script>
</body>
</html>
